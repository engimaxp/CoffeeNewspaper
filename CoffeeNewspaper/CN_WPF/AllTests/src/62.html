<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\coffeenewspaper_unittest\integrationtest\repositorytest\memodatastoretest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.NetworkInformation;
using System.Threading.Tasks;
using CN_Core;
using CN_Repository;
using CoffeeNewspaper_UnitTest.DomainTest;
using NUnit.Framework;

namespace CoffeeNewspaper_UnitTest.RepositoryTest
{
    /// &lt;summary&gt;
    ///     In-Memory integration data persistent test
    /// &lt;/summary&gt;
    [TestFixture]
    public class MemoDataStoreTest : RepositarySetupAndTearDown
    {
        [Test]
        public async Task AddMemo_QueryAllMemo_QuerySpecifiedMemo_AllPass()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                //Arrange argument to be tested
                var assesMemo = DomainTestHelper.GetARandomMemo();

                //initiate the datastore
                var MemoDataStore = new MemoDataStore(dbcontext);

                //do testing action
                MemoDataStore.AddMemo(assesMemo);
                await unitOfWork.Commit();
                //query the result from db for assert
                var Memos = await MemoDataStore.GetAllGlobalMemos();
                Memos.ToList().ForEach(Console.WriteLine);

                var firstMemo = await MemoDataStore.GetMemoById(Memos.First().MemoId);

                Assert.AreEqual(Memos.First(), firstMemo);
                Assert.AreEqual(Memos.FirstOrDefault(), assesMemo);
            });
        }

        [Test]
        public async Task DeleteAMemo_Success()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = MemoDataStore.AddMemo(assesMemo);

                await unitOfWork.Commit();
                MemoDataStore.DeleteMemo(addedMemo);

                var beforeDeleteResult = await unitOfWork.Commit();
                Assert.IsTrue(beforeDeleteResult);

                var afterDeleteResult = await MemoDataStore.GetMemoById(addedMemo.MemoId);
                Assert.IsNull(afterDeleteResult);
            });
        }

        [Test]
        public async Task DeleteAMemo_MemoIdNotExist_Fail()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo(true);
                MemoDataStore.DeleteMemo(assesMemo);
                var beforeDeleteResult = await unitOfWork.Commit();
                Assert.IsFalse(beforeDeleteResult);
            });
        }

        [Test]
        public async Task QuerySpecifiedMemoDoesntExist_ReturnNull()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var firstMemo = await MemoDataStore.GetMemoById(Guid.NewGuid().ToString(&quot;D&quot;));

                Assert.IsNull(firstMemo);
            });
        }

        [Test]
        public async Task UpdateMemo()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = MemoDataStore.AddMemo(assesMemo);
                await unitOfWork.Commit();
                //update the added Memo content,make sure its not equal to original Memo
                addedMemo.Content = &quot;testing update&quot;;

                //update to database ,make sure what ef return is equal to modified Memo
                 MemoDataStore.UpdateMemo(addedMemo);

                var updatedResult = await unitOfWork.Commit();
                Assert.IsTrue(updatedResult);
                //select from db again ,make sure the Memo is updated
                var selectedMemo = await MemoDataStore.GetMemoById(addedMemo.MemoId);
                Assert.AreEqual(selectedMemo, addedMemo);
            });
        }

        [Test]
        public async Task UpdateMemo_MemoIdNotExist_Fail()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo(true);

                //update the added Memo content,make sure its not equal to original Memo
                assesMemo.Content = &quot;testing update&quot;;

                //update to database ,make sure what ef return is equal to modified Memo
                 MemoDataStore.UpdateMemo(assesMemo);

                var updatedResult = await unitOfWork.Commit();
                Assert.False(updatedResult);
            });
        }

        [Test]
        public async Task Clone_SimpleGlobalMemo()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = MemoDataStore.AddMemo(assesMemo);
                await unitOfWork.Commit();
                var cloneMemo = MemoDataStore.CloneAMemo(addedMemo.MemoId);
                await unitOfWork.Commit();

                var allMemos = await MemoDataStore.GetAllGlobalMemos();
                Assert.AreEqual(2,allMemos.Count);

                Assert.IsNotNull(cloneMemo);
                Assert.AreNotEqual(addedMemo.MemoId,cloneMemo.MemoId);
            });
        }

        [Test]
        public async Task Clone_OriginalMemoNull_ReturnFalse()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = MemoDataStore.AddMemo(assesMemo);
                await unitOfWork.Commit();
                var cloneMemo = MemoDataStore.CloneAMemo(Guid.NewGuid().ToString(&quot;N&quot;));
                await unitOfWork.Commit();

                var allMemos = await MemoDataStore.GetAllGlobalMemos();
                Assert.AreEqual(1, allMemos.Count);

                Assert.IsNull(cloneMemo);
            });
        }

        [Test]
        public async Task GetAllTaskMemos_Success()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);

                var taskDataStore = new TaskDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var assesTask = DomainTestHelper.GetARandomTask();
                assesTask.TaskMemos = new List&lt;CNTaskMemo&gt;(){new CNTaskMemo(){Memo = assesMemo,Task = assesTask}};
                var addedTask = taskDataStore.AddTask(assesTask);

                await unitOfWork.Commit();
                var allMemos = await MemoDataStore.GetAllTaskMemos(addedTask.TaskId);
                Assert.AreEqual(1, allMemos.Count);
                Assert.AreEqual(assesMemo.Content, allMemos.First().Content);
            });
        }

        /// &lt;summary&gt;
        /// Some Memo Contain Relations
        /// this test will assert those relations are cloned properly
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Test]
        public async Task Clone_ComplicatedMemo()
        {
            await UseMemoryContextRun(async (dbcontext,unitOfWork) =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);

                //arrange initial entity
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var task = DomainTestHelper.GetARandomTask();
                var tags = new[] {DomainTestHelper.GetARandomTag(), DomainTestHelper.GetARandomTag()}.ToList();

                //add relations
                assesMemo.TaskMemos = new List&lt;CNTaskMemo&gt;(){new CNTaskMemo(){Memo = assesMemo,Task = task}};
                task.TaskTaggers = tags.Select(x=&gt;new CNTaskTagger(){Tag =x,Task = task}).ToList();
                assesMemo.MemoTaggers = tags.Select(x =&gt; new CNMemoTagger() { Tag = x, Memo = assesMemo }).ToList();

                var addedMemo = MemoDataStore.AddMemo(assesMemo);
                await unitOfWork.Commit();
                var cloneMemo = MemoDataStore.CloneAMemo(addedMemo.MemoId);
                await unitOfWork.Commit();

                Assert.AreEqual(addedMemo.TaskMemos.First().TaskId, cloneMemo.TaskMemos.First().TaskId);
                Assert.AreEqual(addedMemo.MemoTaggers.First().TagId, cloneMemo.MemoTaggers.First().TagId);

            });
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,23,13,1],[23,13,23,14,1],[23,14,25,17,1],[25,17,25,67,1],[25,67,28,17,1],[28,17,28,66,1],[28,66,31,17,1],[31,17,31,50,1],[31,50,32,17,1],[32,17,32,43,1],[32,43,34,17,1],[34,17,34,69,1],[34,69,35,17,1],[35,17,35,59,1],[35,59,37,17,1],[37,17,37,87,1],[37,87,39,17,1],[39,17,39,59,1],[39,59,40,17,1],[40,17,40,68,1],[40,68,41,13,1],[41,13,41,14,1],[41,14,41,16,1],[22,13,41,16,1],[42,9,42,10,1],[46,9,46,10,1],[47,13,48,13,1],[48,13,48,14,1],[48,14,49,17,1],[49,17,49,66,1],[49,66,50,17,1],[50,17,50,67,1],[50,67,51,17,1],[51,17,51,66,1],[51,66,53,17,1],[53,17,53,43,1],[53,43,54,17,1],[54,17,54,53,1],[54,53,56,17,1],[56,17,56,68,1],[56,68,57,17,1],[57,17,57,51,1],[57,51,59,17,1],[59,17,59,91,1],[59,91,60,17,1],[60,17,60,50,1],[60,50,61,13,1],[61,13,61,14,1],[61,14,61,16,1],[47,13,61,16,1],[62,9,62,10,1],[66,9,66,10,1],[67,13,68,13,1],[68,13,68,14,1],[68,14,69,17,1],[69,17,69,66,1],[69,66,70,17,1],[70,17,70,71,1],[70,71,71,17,1],[71,17,71,53,1],[71,53,72,17,1],[72,17,72,68,1],[72,68,73,17,1],[73,17,73,52,1],[73,52,74,13,1],[74,13,74,14,1],[74,14,74,16,1],[67,13,74,16,1],[75,9,75,10,1],[79,9,79,10,1],[80,13,81,13,1],[81,13,81,14,1],[81,14,82,17,1],[82,17,82,66,1],[82,66,83,17,1],[83,17,83,95,1],[83,95,85,17,1],[85,17,85,42,1],[85,42,86,13,1],[86,13,86,14,1],[86,14,86,16,1],[80,13,86,16,1],[87,9,87,10,1],[91,9,91,10,1],[92,13,93,13,1],[93,13,93,14,1],[93,14,94,17,1],[94,17,94,66,1],[94,66,95,17,1],[95,17,95,67,1],[95,67,96,17,1],[96,17,96,66,1],[96,66,97,17,1],[97,17,97,43,1],[97,43,99,17,1],[99,17,99,54,1],[99,54,102,18,1],[102,18,102,54,1],[102,54,104,17,1],[104,17,104,63,1],[104,63,105,17,1],[105,17,105,46,1],[105,46,107,17,1],[107,17,107,86,1],[107,86,108,17,1],[108,17,108,58,1],[108,58,109,13,1],[109,13,109,14,1],[109,14,109,16,1],[92,13,109,16,1],[110,9,110,10,1],[114,9,114,10,1],[115,13,116,13,1],[116,13,116,14,1],[116,14,117,17,1],[117,17,117,66,1],[117,66,118,17,1],[118,17,118,71,1],[118,71,121,17,1],[121,17,121,54,1],[121,54,124,18,1],[124,18,124,54,1],[124,54,126,17,1],[126,17,126,63,1],[126,63,127,17,1],[127,17,127,45,1],[127,45,128,13,1],[128,13,128,14,1],[128,14,128,16,1],[115,13,128,16,1],[129,9,129,10,1],[133,9,133,10,1],[134,13,135,13,1],[135,13,135,14,1],[135,14,136,17,1],[136,17,136,66,1],[136,66,137,17,1],[137,17,137,67,1],[137,67,138,17,1],[138,17,138,66,1],[138,66,139,17,1],[139,17,139,43,1],[139,43,140,17,1],[140,17,140,76,1],[140,76,141,17,1],[141,17,141,43,1],[141,43,143,17,1],[143,17,143,72,1],[143,72,144,17,1],[144,17,144,51,1],[144,51,146,17,1],[146,17,146,45,1],[146,45,147,17,1],[147,17,147,71,1],[147,71,148,13,1],[148,13,148,14,1],[148,14,148,16,1],[134,13,148,16,1],[149,9,149,10,1],[153,9,153,10,1],[154,13,155,13,1],[155,13,155,14,1],[155,14,156,17,1],[156,17,156,66,1],[156,66,157,17,1],[157,17,157,67,1],[157,67,158,17,1],[158,17,158,66,1],[158,66,159,17,1],[159,17,159,43,1],[159,43,160,17,1],[160,17,160,88,1],[160,88,161,17,1],[161,17,161,43,1],[161,43,163,17,1],[163,17,163,72,1],[163,72,164,17,1],[164,17,164,52,1],[164,52,166,17,1],[166,17,166,42,1],[166,42,167,13,1],[167,13,167,14,1],[167,14,167,16,1],[154,13,167,16,1],[168,9,168,10,1],[172,9,172,10,1],[173,13,174,13,1],[174,13,174,14,1],[174,14,175,17,1],[175,17,175,66,1],[175,66,177,17,1],[177,17,177,66,1],[177,66,178,17,1],[178,17,178,67,1],[178,67,179,17,1],[179,17,179,67,1],[179,67,180,17,1],[180,17,180,115,1],[180,115,181,17,1],[181,17,181,66,1],[181,66,183,17,1],[183,17,183,43,1],[183,43,184,17,1],[184,17,184,86,1],[184,86,185,17,1],[185,17,185,52,1],[185,52,186,17,1],[186,17,186,78,1],[186,78,187,13,1],[187,13,187,14,1],[187,14,187,16,1],[173,13,187,16,1],[188,9,188,10,1],[197,9,197,10,1],[198,13,199,13,1],[199,13,199,14,1],[199,14,200,17,1],[200,17,200,66,1],[200,66,203,17,1],[203,17,203,67,1],[203,67,204,17,1],[204,17,204,62,1],[204,62,205,17,1],[205,17,205,112,1],[205,112,208,17,1],[208,17,208,110,1],[208,110,209,17,1],[209,17,209,51,1],[209,51,209,89,1],[209,89,209,100,1],[209,17,209,100,1],[209,100,210,17,1],[210,17,210,58,1],[210,58,210,106,1],[210,106,210,117,1],[210,17,210,117,1],[210,117,212,17,1],[212,17,212,66,1],[212,66,213,17,1],[213,17,213,43,1],[213,43,214,17,1],[214,17,214,76,1],[214,76,215,17,1],[215,17,215,43,1],[215,43,217,17,1],[217,17,217,105,1],[217,105,218,17,1],[218,17,218,107,1],[218,107,220,13,1],[220,13,220,14,1],[220,14,220,16,1],[198,13,220,16,1],[221,9,221,10,1]]);
    </script>
  </body>
</html>