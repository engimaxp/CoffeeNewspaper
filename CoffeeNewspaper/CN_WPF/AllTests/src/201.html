<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\cn_core\domainmodel\cntimeslice.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;

namespace CN_Core
{
    /// &lt;summary&gt;
    ///     A task&#39;s duration is a combination of its timeslices
    /// &lt;/summary&gt;
    public class CNTimeSlice : IEquatable&lt;CNTimeSlice&gt;, ICloneable, IComparable&lt;CNTimeSlice&gt;
    {
        #region Private Properties

        /// &lt;summary&gt;
        ///     store the calculated day duration of this instance
        /// &lt;/summary&gt;
        private CNTimeSlice dayDuration;

        #endregion

        #region Constructor

        /// &lt;summary&gt;
        ///     must have start date to create a timeslice
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;startDateTime&quot;&gt;start time of this slice&lt;/param&gt;
        /// &lt;param name=&quot;endDateTime&quot;&gt;end time of this slice , null if not give a value&lt;/param&gt;
        public CNTimeSlice(DateTime startDateTime, DateTime? endDateTime = null)
        {
            StartDateTime = startDateTime;
            if (endDateTime != null &amp;&amp; endDateTime &lt;= startDateTime)
                throw new ArgumentException(&quot;A TimeSlice&#39;s EndTime Must Greater Than StartTime&quot;);
            EndDateTime = endDateTime;
        }
        /// &lt;summary&gt;
        /// EF requires a parameterless constructor be declared
        /// &lt;/summary&gt;
        public CNTimeSlice()
        {
            
        }
        #endregion

        #region Interface Implementation

        #region Clone implement

        public object Clone()
        {
            return new CNTimeSlice(StartDateTime, EndDateTime)
            {
                TimeSliceId = TimeSliceId,
                TaskId = TaskId
            };
        }

        #endregion

        #region Comparable implement

        /// &lt;summary&gt;
        ///     compare two timeslice just by startDateTime
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;other&quot;&gt;the timeslice to compare&lt;/param&gt;
        /// &lt;returns&gt;
        ///     1 if this StartTime greater than other StartTime
        ///     0 if its equal
        ///     -1 if its lesser
        /// &lt;/returns&gt;
        public int CompareTo(CNTimeSlice other)
        {
            if (StartDateTime &gt; other.StartDateTime) return 1;
            else if (StartDateTime.Equals(other.StartDateTime)) return 0;
            return -1;
        }

        #endregion

        #region Formatting implement

        public override string ToString()
        {
            return $&quot;{nameof(StartDateTime)}: {StartDateTime}, {nameof(EndDateTime)}: {EndDateTime}&quot;;
        }

        #endregion

        #region Equality Implement
        

        private sealed class StartDateTimeEndDateTimeEqualityComparer : IEqualityComparer&lt;CNTimeSlice&gt;
        {
            public bool Equals(CNTimeSlice x, CNTimeSlice y)
            {
                if (ReferenceEquals(x, y)) return true;
                if (ReferenceEquals(x, null)) return false;
                if (ReferenceEquals(y, null)) return false;
                if (x.GetType() != y.GetType()) return false;
                return x.StartDateTime.Equals(y.StartDateTime) &amp;&amp; x.EndDateTime.Equals(y.EndDateTime);
            }

            public int GetHashCode(CNTimeSlice obj)
            {
                return obj.ToString().GetHashCode();
            }
        }

        public static IEqualityComparer&lt;CNTimeSlice&gt; StartDateTimeEndDateTimeComparer { get; } =
            new StartDateTimeEndDateTimeEqualityComparer();

        public bool Equals(CNTimeSlice other)
        {
            if (ReferenceEquals(null, other)) return false;
            if (ReferenceEquals(this, other)) return true;
            return StartDateTime.Equals(other.StartDateTime) &amp;&amp; EndDateTime.Equals(other.EndDateTime);
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj)) return false;
            if (ReferenceEquals(this, obj)) return true;
            if (obj.GetType() != GetType()) return false;
            return Equals((CNTimeSlice) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                return (StartDateTime.GetHashCode() * 397) ^ EndDateTime.GetHashCode();
            }
        }

        #endregion

        #endregion

        #region Public Properties

        /// &lt;summary&gt;
        ///     Id of this timeSlice entity
        /// &lt;/summary&gt;
        public string TimeSliceId { get; set; }

        /// &lt;summary&gt;
        ///     Start time of this slice
        /// &lt;/summary&gt;
        public DateTime StartDateTime { get; set; }

        /// &lt;summary&gt;
        ///     End time of this slice
        /// &lt;/summary&gt;
        public DateTime? EndDateTime { get; set; }

        /// &lt;summary&gt;
        ///     The id of which task this slice belongs to
        /// &lt;/summary&gt;
        public int TaskId { get; set; }

        /// &lt;summary&gt;
        ///     Which task this slice belongs to
        /// &lt;/summary&gt;
        public virtual CNTask Task { get; set; }
        
        #endregion

        #region Public Methods

        /// &lt;summary&gt;
        ///     Change current timeslice to normalized form like yyyy-MM-dd 00:00:00 - yyyy-MM-dd+N 23:59:59.999
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public CNTimeSlice GetDayDuration()
        {
            if (StartDateTime &gt; DateTime.Now) return null;
            return dayDuration ??
                   (dayDuration = new CNTimeSlice(StartDateTime.Date,
                       (EndDateTime ?? DateTime.Now).Date &gt; StartDateTime.Date
                           ? (EndDateTime ?? DateTime.Now).Date.AddDays(1).AddMilliseconds(-1)
                           : StartDateTime.Date.AddDays(1).AddMilliseconds(-1)));
        }

        /// &lt;summary&gt;
        ///     Means otherTimeSlice is a SubSet of this timeSlice, if a equals b means they contain each other
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;otherTimeSlice&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;true if this instance contain &lt;see cref=&quot;otherTimeSlice&quot; /&gt;&lt;/returns&gt;
        public bool IsContaining(CNTimeSlice otherTimeSlice)
        {
            if (!EndDateTime.HasValue || !otherTimeSlice.EndDateTime.HasValue) return false;
            return StartDateTime &lt;= otherTimeSlice.StartDateTime &amp;&amp;
                   EndDateTime.Value &gt;= otherTimeSlice.EndDateTime.Value;
        }

        /// &lt;summary&gt;
        ///     Get timeSlice&#39;s using days,start today end tomorrow means two days
        /// &lt;/summary&gt;
        /// &lt;returns&gt;the days this slice encontered&lt;/returns&gt;
        public int GetWorkDays()
        {
            if (EndDateTime == null) return 0;
            return Convert.ToInt32(Math.Ceiling(Convert.ToDecimal((EndDateTime.Value - StartDateTime).TotalDays)));
        }

        /// &lt;summary&gt;
        ///     Two TimeSlices InterceptWith Another:
        ///     1. Both dont have EndTime
        ///     2. One has no EndTime and its starttime greater than the others endTime
        ///     3. One contains anoter
        ///     4. Not when one&#39;s startTime and endTime both lesser than another&#39;s StartTime
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;timeSlice&quot;&gt;the other timeslice&lt;/param&gt;
        /// &lt;returns&gt;true if this instance intercept with &lt;see cref=&quot;timeSlice&quot; /&gt;&lt;/returns&gt;
        public bool InterceptWith(CNTimeSlice timeSlice)
        {
            if (timeSlice == null) return false;
            // Both dont have EndTime
            if (EndDateTime == null &amp;&amp; timeSlice.EndDateTime == null)
            {
                return true;
            }
            // One has no EndTime and its starttime bigger than the others endTime
            else if (EndDateTime == null || timeSlice.EndDateTime == null)
            {
                var endtime = EndDateTime ?? timeSlice.EndDateTime;
                var starttime = EndDateTime == null ? StartDateTime : timeSlice.StartDateTime;
                return !endtime.HasValue || endtime.Value &gt;= starttime;
            }

            // One contains anoter
            // Not when one&#39;s startTime and endTime both lesser than another&#39;s StartTime
            if (EndDateTime.Value &lt;= timeSlice.StartDateTime)
                return false;
            if (timeSlice.EndDateTime.Value &lt;= StartDateTime)
                return false;

            // Other circumstances returns true
            return true;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,81,1],[28,9,28,10,1],[29,13,29,43,1],[30,13,30,69,1],[31,17,31,98,1],[32,13,32,39,1],[33,9,33,10,1],[37,9,37,29,0],[38,9,38,10,0],[40,9,40,10,0],[48,9,48,10,1],[49,13,53,15,1],[54,9,54,10,1],[70,9,70,10,1],[71,13,71,53,1],[71,54,71,63,1],[72,18,72,64,1],[72,65,72,74,0],[73,13,73,23,1],[74,9,74,10,1],[81,9,81,10,1],[82,13,82,102,1],[83,9,83,10,1],[93,13,93,14,1],[94,17,94,43,1],[94,44,94,56,1],[95,17,95,46,0],[95,47,95,60,0],[96,17,96,46,0],[96,47,96,60,0],[97,17,97,48,0],[97,49,97,62,0],[98,17,98,103,0],[99,13,99,14,1],[102,13,102,14,1],[103,17,103,53,1],[104,13,104,14,1],[107,89,107,93,1],[108,13,108,59,1],[111,9,111,10,1],[112,13,112,46,1],[112,47,112,60,0],[113,13,113,46,1],[113,47,113,59,1],[114,13,114,103,1],[115,9,115,10,1],[118,9,118,10,1],[119,13,119,44,1],[119,45,119,58,0],[120,13,120,44,1],[120,45,120,57,1],[121,13,121,44,1],[121,45,121,58,0],[122,13,122,46,1],[123,9,123,10,1],[126,9,126,10,1],[128,13,128,14,1],[129,17,129,88,1],[131,9,131,10,1],[142,37,142,41,1],[142,42,142,46,1],[147,41,147,45,1],[147,46,147,50,1],[152,40,152,44,1],[152,45,152,49,1],[157,29,157,33,1],[157,34,157,38,1],[162,38,162,42,1],[162,43,162,47,1],[173,9,173,10,1],[174,13,174,46,1],[174,47,174,59,1],[175,13,179,82,1],[180,9,180,10,1],[188,9,188,10,1],[189,13,189,79,1],[189,80,189,93,1],[190,13,191,74,1],[192,9,192,10,1],[199,9,199,10,1],[200,13,200,37,1],[200,38,200,47,1],[201,13,201,116,1],[202,9,202,10,1],[214,9,214,10,1],[215,13,215,35,1],[215,36,215,49,1],[217,13,217,70,1],[218,13,218,14,1],[219,17,219,29,1],[222,18,222,75,1],[223,13,223,14,1],[224,17,224,68,1],[225,17,225,95,1],[226,17,226,72,1],[231,13,231,62,1],[232,17,232,30,1],[233,13,233,62,1],[234,17,234,30,1],[237,13,237,25,1],[238,9,238,10,1]]);
    </script>
  </body>
</html>