<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\cn_repository\datacontext\cndbcontext.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using CN_Core;
using Microsoft.Data.Sqlite;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Diagnostics;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Logging.Debug;

namespace CN_Repository
{
    public class CNDbContext : DbContext
    {
        /// &lt;summary&gt;
        /// default dbfilename
        /// TODO:May change the config to configfile
        /// &lt;/summary&gt;
        public const string dbfilename = &quot;testing.db&quot;;

        public bool InMemoryMode { get; set; } = false;
        
        #region DbSets 

        public DbSet&lt;CNTag&gt; Tags { get; set; }
        public DbSet&lt;CNTask&gt; Tasks { get; set; }
        public DbSet&lt;CNMemo&gt; Memos { get; set; }
        public DbSet&lt;CNTimeSlice&gt; TimeSlices { get; set; }
        public DbSet&lt;CNTaskConnector&gt; TaskConnectors { get; set; }
        public DbSet&lt;CNMemoTagger&gt; MemoTaggers { get; set; }
        public DbSet&lt;CNTaskTagger&gt; TaskTaggers { get; set; }
        public DbSet&lt;CNTaskMemo&gt; TaskMemos { get; set; }


        #endregion

        #region Constructor
        public static readonly LoggerFactory MyLoggerFactory
            = new LoggerFactory(new[] { new DebugLoggerProvider((_, __) =&gt; true) });
        /// &lt;summary&gt;
        /// Get a File Sqlite Database context
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static CNDbContext GetFileSqlDatabase()
        {
            var builder = new DbContextOptionsBuilder&lt;CNDbContext&gt;();
            builder.UseSqlite($&quot;Data Source={dbfilename}&quot;);
            DbContextOptions&lt;CNDbContext&gt; options = builder.Options;
            var dbcontext = new CNDbContext(options);
            dbcontext.Database.EnsureCreated();
            return dbcontext;
        }
        /// &lt;summary&gt;
        /// Get a In-Memory Sqlite Database context
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static CNDbContext GetMemorySqlDatabase()
        {
            var connectionStringBuilder =
                new SqliteConnectionStringBuilder { DataSource = &quot;:memory:&quot; };
            var connectionString = connectionStringBuilder.ToString();
            var connection = new SqliteConnection(connectionString);
            var builder = new DbContextOptionsBuilder&lt;CNDbContext&gt;();
            builder.UseSqlite(connection);
            DbContextOptions&lt;CNDbContext&gt; options = builder.Options;
            return new CNDbContext(options);
        }

        private CNDbContext(DbContextOptions&lt;CNDbContext&gt; options) : base(options)
        {

        }

        #endregion

        #region Configure the path

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            //Add ConsoleLogging
            optionsBuilder
                .ConfigureWarnings(warnnings=&gt;warnnings.Log(CoreEventId.DetachedLazyLoadingWarning))
                .ConfigureWarnings(warnnings=&gt;warnnings.Log(CoreEventId.LazyLoadOnDisposedContextWarning))
                .UseLoggerFactory(MyLoggerFactory)
                .UseLazyLoadingProxies();
        }
        #endregion



        #region Model Creating

        /// &lt;summary&gt;
        /// Configures the database structure and relationships
        /// this config is purely for sqlite3 database
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;modelBuilder&quot;&gt;&lt;/param&gt;
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            #region CNTask Config
            // Set Database Table name
            modelBuilder.Entity&lt;CNTask&gt;().ToTable(nameof(CNTask));
            // Set primary key for the Table ,this will also add a index to database
            modelBuilder.Entity&lt;CNTask&gt;().HasKey(a =&gt; a.TaskId);
            // Set primary key autogenerated for int value,it start from 0 and add 1 per item
            // for string value,it generate random guid
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.TaskId).ValueGeneratedOnAdd();
            // Set Default CreateTime to now
            // Strictly require the ef code first to create the datatype of this field to DateTime
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.CreateTime)
                .HasColumnType(&quot;DATETIME&quot;)
                .HasDefaultValueSql(&quot;strftime(\&#39;%Y-%m-%d %H:%M:%f\&#39;,\&#39;now\&#39;,\&#39;localtime\&#39;)&quot;);
            
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.TaskId).HasColumnType(&quot;INTEGER&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.Content).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.Sort).HasColumnType(&quot;INTEGER&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.PendingReason).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.CreateTime).HasColumnType(&quot;DATETIME&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.DeadLine).HasColumnType(&quot;DATETIME&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.EndTime).HasColumnType(&quot;DATETIME&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.EstimatedDuration).HasColumnType(&quot;BIGINT&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.FailReason).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.IsDeleted).HasColumnType(&quot;BOOLEAN&quot;).HasDefaultValue(false);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.IsFail).HasColumnType(&quot;BOOLEAN&quot;).HasDefaultValue(false);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.ParentTaskID).HasColumnType(&quot;INTEGER&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.StartTime).HasColumnType(&quot;DATETIME&quot;);

            // Set Tasks parentTask foreign key
            // a parent task may have many child tasks
            // so this is a one-too-many relation
            // database will use the ParentTaskID for the database field name
            // On delete Cascade means if the parent task is deleted ,the child tasks is also deleted
            // On delete ClientSetNull means if the parent task is deleted ,the child task&#39;s ParentTaskID field will be set null
            modelBuilder.Entity&lt;CNTask&gt;()
                .HasOne(x =&gt; x.ParentTask)
                .WithMany(y =&gt; y.ChildTasks)
                .HasForeignKey(z =&gt; z.ParentTaskID)
                .OnDelete(DeleteBehavior.ClientSetNull); 
            #endregion
            #region CNMemo Config

            modelBuilder.Entity&lt;CNMemo&gt;().ToTable(nameof(CNMemo));
            modelBuilder.Entity&lt;CNMemo&gt;().HasKey(a =&gt; a.MemoId);
            modelBuilder.Entity&lt;CNMemo&gt;().Property(x =&gt; x.MemoId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTask&gt;().Property(x =&gt; x.Sort).HasColumnType(&quot;INTEGER&quot;);
            modelBuilder.Entity&lt;CNMemo&gt;().Property(x =&gt; x.Content).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNMemo&gt;().Property(x =&gt; x.Title).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNMemo&gt;().Property(x =&gt; x.MemoId).ValueGeneratedOnAdd(); 
            #endregion
            #region CNTag Config

            modelBuilder.Entity&lt;CNTag&gt;().ToTable(nameof(CNTag));
            modelBuilder.Entity&lt;CNTag&gt;().HasKey(a =&gt; a.TagId);
            modelBuilder.Entity&lt;CNTag&gt;().Property(x =&gt; x.TagId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTag&gt;().Property(x =&gt; x.Title).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTag&gt;().Property(x =&gt; x.TagId).ValueGeneratedOnAdd();
            modelBuilder.Entity&lt;CNTag&gt;().HasIndex(x =&gt; x.Title).IsUnique(); 
            #endregion
            #region CNTimeSlice Config

            modelBuilder.Entity&lt;CNTimeSlice&gt;().ToTable(nameof(CNTimeSlice));
            modelBuilder.Entity&lt;CNTimeSlice&gt;().HasKey(a =&gt; a.TimeSliceId);
            modelBuilder.Entity&lt;CNTimeSlice&gt;().Property(x =&gt; x.TimeSliceId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTimeSlice&gt;().Property(x =&gt; x.StartDateTime).HasColumnType(&quot;DATETIME&quot;);
            modelBuilder.Entity&lt;CNTimeSlice&gt;().Property(x =&gt; x.EndDateTime).HasColumnType(&quot;DATETIME&quot;);
            modelBuilder.Entity&lt;CNTimeSlice&gt;().Property(x =&gt; x.TimeSliceId).ValueGeneratedOnAdd();
            modelBuilder.Entity&lt;CNTimeSlice&gt;()
                .HasOne(x =&gt; x.Task)
                .WithMany(y =&gt; y.UsedTimeSlices)
                .HasForeignKey(x =&gt; x.TaskId)
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired(); 
            #endregion
            #region CNTaskConnector Config


            modelBuilder.Entity&lt;CNTaskConnector&gt;().ToTable(nameof(CNTaskConnector));
            modelBuilder.Entity&lt;CNTaskConnector&gt;().HasKey(a =&gt; a.TaskConnectorId);
            modelBuilder.Entity&lt;CNTaskConnector&gt;().Property(x =&gt; x.TaskConnectorId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTaskConnector&gt;().Property(x =&gt; x.TaskConnectorId).ValueGeneratedOnAdd();
            modelBuilder.Entity&lt;CNTaskConnector&gt;().HasOne(x =&gt; x.PreTask)
                .WithMany(y =&gt; y.SufTaskConnectors)
                .HasForeignKey(z =&gt; z.PreTaskId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNTaskConnector&gt;().HasOne(x =&gt; x.SufTask)
                .WithMany(y =&gt; y.PreTaskConnectors)
                .HasForeignKey(z =&gt; z.SufTaskId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNTaskConnector&gt;()
                .HasIndex(p =&gt; new { p.PreTaskId, p.SufTaskId })
                .IsUnique(); 
            #endregion
            #region CNMemoTagger Config

            modelBuilder.Entity&lt;CNMemoTagger&gt;().ToTable(nameof(CNMemoTagger));
            modelBuilder.Entity&lt;CNMemoTagger&gt;().HasKey(a =&gt; a.MemoTaggerId);
            modelBuilder.Entity&lt;CNMemoTagger&gt;().Property(x =&gt; x.MemoTaggerId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNMemoTagger&gt;().Property(x =&gt; x.TagId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNMemoTagger&gt;().Property(x =&gt; x.MemoId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNMemoTagger&gt;().Property(x =&gt; x.MemoTaggerId).ValueGeneratedOnAdd();
            modelBuilder.Entity&lt;CNMemoTagger&gt;()
                .HasOne(x =&gt; x.Memo)
                .WithMany(y =&gt; y.MemoTaggers)
                .HasForeignKey(z =&gt; z.MemoId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNMemoTagger&gt;()
                .HasOne(x =&gt; x.Tag)
                .WithMany(y =&gt; y.MemoTaggers)
                .HasForeignKey(z =&gt; z.TagId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNMemoTagger&gt;()
                .HasIndex(p =&gt; new { p.TagId, p.MemoId })
                .IsUnique(); 
            #endregion
            #region CNTaskTagger Config

            modelBuilder.Entity&lt;CNTaskTagger&gt;().ToTable(nameof(CNTaskTagger));
            modelBuilder.Entity&lt;CNTaskTagger&gt;().HasKey(a =&gt; a.TaskTaggerId);
            modelBuilder.Entity&lt;CNTaskTagger&gt;().Property(x =&gt; x.TaskTaggerId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTaskTagger&gt;().Property(x =&gt; x.TagId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTaskTagger&gt;().Property(x =&gt; x.TaskTaggerId).ValueGeneratedOnAdd();
            modelBuilder.Entity&lt;CNTaskTagger&gt;()
                .HasOne(x =&gt; x.Task)
                .WithMany(y =&gt; y.TaskTaggers)
                .HasForeignKey(z =&gt; z.TaskId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNTaskTagger&gt;()
                .HasOne(x =&gt; x.Tag)
                .WithMany(y =&gt; y.TaskTaggers)
                .HasForeignKey(z =&gt; z.TagId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNTaskTagger&gt;()
                .HasIndex(p =&gt; new { p.TagId, p.TaskId })
                .IsUnique(); 
            #endregion

            #region CNTaskMemo Config

            modelBuilder.Entity&lt;CNTaskMemo&gt;().ToTable(nameof(CNTaskMemo));
            modelBuilder.Entity&lt;CNTaskMemo&gt;().HasKey(a =&gt; a.TaskMemoId);
            modelBuilder.Entity&lt;CNTaskMemo&gt;().Property(x =&gt; x.TaskMemoId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTaskMemo&gt;().Property(x =&gt; x.MemoId).HasColumnType(&quot;VARCHAR&quot;);
            modelBuilder.Entity&lt;CNTaskMemo&gt;().Property(x =&gt; x.TaskMemoId).ValueGeneratedOnAdd();
            modelBuilder.Entity&lt;CNTaskMemo&gt;()
                .HasOne(x =&gt; x.Task)
                .WithMany(y =&gt; y.TaskMemos)
                .HasForeignKey(z =&gt; z.TaskId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNTaskMemo&gt;()
                .HasOne(x =&gt; x.Memo)
                .WithMany(y =&gt; y.TaskMemos)
                .HasForeignKey(z =&gt; z.MemoId)
                .IsRequired()
                .OnDelete(DeleteBehavior.Cascade);
            modelBuilder.Entity&lt;CNTaskMemo&gt;()
                .HasIndex(p =&gt; new { p.TaskId, p.MemoId })
                .IsUnique(); 
            #endregion
            
        }

        #endregion

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,36,18,40,0],[18,41,18,45,0],[18,50,18,55,1],[22,36,22,40,1],[22,41,22,45,1],[23,38,23,42,1],[23,43,23,47,1],[24,38,24,42,1],[24,43,24,47,1],[25,48,25,52,1],[25,53,25,57,1],[26,56,26,60,1],[26,61,26,65,1],[27,50,27,54,1],[27,55,27,59,1],[28,50,28,54,1],[28,55,28,59,1],[29,46,29,50,1],[29,51,29,55,1],[35,9,36,76,1],[36,76,36,80,0],[36,80,36,85,1],[35,9,36,85,1],[42,9,42,10,0],[43,13,43,70,0],[44,13,44,60,0],[45,13,45,69,0],[46,13,46,54,0],[47,13,47,48,0],[48,13,48,30,0],[49,9,49,10,0],[55,9,55,10,1],[56,13,57,79,1],[58,13,58,71,1],[59,13,59,69,1],[60,13,60,70,1],[61,13,61,43,1],[62,13,62,69,1],[63,13,63,45,1],[64,9,64,10,1],[66,70,66,83,1],[67,9,67,10,1],[69,9,69,10,1],[76,9,76,10,1],[78,13,79,47,1],[79,47,79,100,1],[79,100,80,47,1],[80,47,80,106,1],[80,106,82,42,1],[78,13,82,42,1],[83,9,83,10,1],[96,9,96,10,1],[97,13,97,48,1],[101,13,101,67,1],[103,13,103,65,1],[106,13,106,89,1],[109,13,111,94,1],[113,13,113,92,1],[114,13,114,93,1],[115,13,115,90,1],[116,13,116,99,1],[117,13,117,97,1],[118,13,118,95,1],[119,13,119,94,1],[120,13,120,102,1],[121,13,121,96,1],[122,13,122,118,1],[123,13,123,115,1],[124,13,124,98,1],[125,13,125,96,1],[133,13,137,57,1],[141,13,141,67,1],[142,13,142,65,1],[143,13,143,92,1],[144,13,144,90,1],[145,13,145,93,1],[146,13,146,91,1],[147,13,147,89,1],[151,13,151,65,1],[152,13,152,63,1],[153,13,153,90,1],[154,13,154,90,1],[155,13,155,87,1],[156,13,156,76,1],[160,13,160,77,1],[161,13,161,75,1],[162,13,162,102,1],[163,13,163,105,1],[164,13,164,103,1],[165,13,165,99,1],[166,13,171,31,1],[176,13,176,85,1],[177,13,177,83,1],[178,13,178,110,1],[179,13,179,107,1],[180,13,184,51,1],[185,13,189,51,1],[190,13,192,29,1],[196,13,196,79,1],[197,13,197,77,1],[198,13,198,104,1],[199,13,199,97,1],[200,13,200,98,1],[201,13,201,101,1],[202,13,207,51,1],[208,13,213,51,1],[214,13,216,29,1],[220,13,220,79,1],[221,13,221,77,1],[222,13,222,104,1],[223,13,223,97,1],[224,13,224,101,1],[225,13,230,51,1],[231,13,236,51,1],[237,13,239,29,1],[244,13,244,75,1],[245,13,245,73,1],[246,13,246,100,1],[247,13,247,96,1],[248,13,248,97,1],[249,13,254,51,1],[255,13,260,51,1],[261,13,263,29,1],[266,9,266,10,1]]);
    </script>
  </body>
</html>