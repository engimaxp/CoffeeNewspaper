<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\cn_service\serviceimplement\memoservice.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using CN_Core;
using CN_Core.Interfaces;
using CN_Core.Interfaces.Repository;
using CN_Core.Interfaces.Service;

namespace CN_Service
{
    public class MemoService : IMemoService
    {
        private readonly IMemoDataStore memoDataStore;
        private readonly ITaskDataStore taskDataStore;
        private readonly IUnitOfWork unitOfWork;

        public MemoService(IUnitOfWork UnitOfWork, IMemoDataStore MemoDataStore, ITaskDataStore TaskDataStore)
        {
            unitOfWork = UnitOfWork;
            memoDataStore = MemoDataStore;
            taskDataStore = TaskDataStore;
        }

        public async Task&lt;string&gt; AddAMemoToTask(CNMemo memo, int taskid)
        {
                if (memo == null) return string.Empty;
                var task = await taskDataStore.GetTask(taskid);
                if (task == null) return string.Empty;
                //Add memo To Task
                memo.TaskMemos.Add(new CNTaskMemo
                {
                    Task = task,
                    Memo = memo
                });
                //if MemoId is Null add the Memo
                if (string.IsNullOrEmpty(memo.MemoId))
                {
                    var memo1 = memo;
                    task.TaskTaggers.Select(x =&gt; x.Tag)
                        .ToList()
                        .ForEach(y =&gt; memo1.MemoTaggers.Add(new CNMemoTagger {Memo = memo1, Tag = y}));
                    memo = memoDataStore.AddMemo(memo);
                }
                //else Update it
                else
                {
                    memoDataStore.UpdateMemo(memo);
                }

                await unitOfWork.Commit();
                return memo?.MemoId;
        }

        public async Task&lt;string&gt; AddAMemoToGlobal(CNMemo memo)
        {
                if (memo == null) return string.Empty;
                memo = memoDataStore.AddMemo(memo);
                return await unitOfWork.Commit() ? memo?.MemoId : null;
        }

        public async Task&lt;bool&gt; UpdateAMemo(CNMemo memo)
        {
                if (memo == null) return false;
                memoDataStore.UpdateMemo(memo);
                return await unitOfWork.Commit();
        }

        public async Task&lt;bool&gt; DeleteAMemo(string memoId)
        {
                var memo = await memoDataStore.GetMemoById(memoId);
                if (memo == null) return false;
                memoDataStore.DeleteMemo(memo);
                return await unitOfWork.Commit();
        }

        public async Task&lt;bool&gt; RemoveAMemoFromTask(string memoId, int taskId)
        {
                //Assert memo exist
                var memo = await memoDataStore.GetMemoById(memoId);
                if (memo == null) return false;
                //Assert memo-task relation exist
                var tobeRemovedRelations = memo.TaskMemos.Where(x =&gt; x.TaskId == taskId).ToList();
                if (!tobeRemovedRelations.Any()) return false;
                //remove and update
                tobeRemovedRelations.ToList().ForEach(x =&gt; memo.TaskMemos.Remove(x));
                memoDataStore.UpdateMemo(memo);
                return await unitOfWork.Commit();
        }

        public async Task&lt;ICollection&lt;CNMemo&gt;&gt; GetAllGlobalMemos()
        {
                return await memoDataStore.GetAllGlobalMemos();
        }

        public async Task&lt;ICollection&lt;CNMemo&gt;&gt; GetAllTaskMemos(int taskid)
        {
                return await memoDataStore.GetAllTaskMemos(taskid);
        }

        public async Task&lt;CNMemo&gt; GetMemoById(string memoId)
        {
                return await memoDataStore.GetMemoById(memoId);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,111,1],[18,9,18,10,1],[19,13,19,37,1],[20,13,20,43,1],[21,13,21,43,1],[22,9,22,10,1],[25,9,25,10,1],[26,17,26,34,1],[26,35,26,55,1],[27,17,27,64,1],[28,17,28,34,1],[28,35,28,55,1],[30,17,34,20,1],[36,17,36,55,1],[37,17,37,18,1],[38,21,38,38,1],[39,21,39,50,1],[39,50,39,55,1],[39,55,41,39,1],[41,39,41,102,1],[41,102,41,104,1],[39,21,41,104,1],[42,21,42,56,1],[43,17,43,18,1],[46,17,46,18,1],[47,21,47,52,1],[48,17,48,18,1],[50,17,50,43,1],[51,17,51,37,1],[52,9,52,10,1],[55,9,55,10,1],[56,17,56,34,1],[56,35,56,55,1],[57,17,57,52,1],[58,17,58,72,1],[59,9,59,10,1],[62,9,62,10,1],[63,17,63,34,1],[63,35,63,48,1],[64,17,64,48,1],[65,17,65,50,1],[66,9,66,10,1],[69,9,69,10,1],[70,17,70,68,1],[71,17,71,34,1],[71,35,71,48,1],[72,17,72,48,1],[73,17,73,50,1],[74,9,74,10,1],[77,9,77,10,1],[79,17,79,68,1],[80,17,80,34,1],[80,35,80,48,1],[82,17,82,70,1],[82,70,82,88,1],[82,88,82,99,1],[82,17,82,99,1],[83,17,83,49,1],[83,50,83,63,1],[85,17,85,60,1],[85,60,85,84,1],[85,84,85,86,1],[85,17,85,86,1],[86,17,86,48,1],[87,17,87,50,1],[88,9,88,10,1],[91,9,91,10,1],[92,17,92,64,1],[93,9,93,10,1],[96,9,96,10,1],[97,17,97,68,1],[98,9,98,10,1],[101,9,101,10,1],[102,17,102,64,1],[103,9,103,10,1]]);
    </script>
  </body>
</html>