<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\cn_cli\command\tagcommand.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Drawing;
using System.Linq;
using System.Threading.Tasks;
using CN_Core;
using Colorful;

namespace CoffeeNewspaper_CLI
{
    public class TagCommand : BaseCommand
    {
        public TagCommand(BaseState state) : base(state)
        {
            Name = &quot;tag&quot;;
        }

        public override async Task&lt;BaseState&gt; Excute(ArgumentParser input)
        {
            await Task.Delay(1);
            if (State != null &amp;&amp; State.StateObj is CNTask task)
            {
                var addTags = input.Get&lt;string&gt;(&quot;add&quot;).Select(x =&gt; new CNTag {Title = x}).ToList();
                if (addTags.Any())
                {
                    //TODO:Extract to Service Implement
                    //union to get a non-repeat TagList
                    var totalTags = addTags.Union(task.TaskTaggers.Select(x =&gt; x.Tag).ToList(), CNTag.TitleComparer);
                    //select the new tags to be added
                    var toBeAddedTag = totalTags.Where(x =&gt; string.IsNullOrEmpty(x.TagId));
                    //add them to task
                    toBeAddedTag.ToList().ForEach(y =&gt;
                        task.TaskTaggers.Add(new CNTaskTagger {Tag = y, TaskId = task.TaskId}));
                }

                var removeTags = input.Get&lt;string&gt;(&quot;remove&quot;).Select(x =&gt; new CNTag {Title = x}).ToList();
                if (removeTags.Any())
                {
                    var toBeRemovedTag = task.TaskTaggers.Select(x =&gt; x.Tag).ToList()
                        .Intersect(removeTags, CNTag.TitleComparer).ToList();
                    toBeRemovedTag.ForEach(x =&gt;
                        task.TaskTaggers.Remove(task.TaskTaggers.FirstOrDefault(y =&gt; y.TagId == x.TagId)));
                }

                State.Refresh();
            }
            else if (State != null &amp;&amp; State.StateObj is CNMemo memo)
            {
                var addTags = input.Get&lt;string&gt;(&quot;add&quot;).Select(x =&gt; new CNTag {Title = x}).ToList();
                if (addTags.Any())
                {
                    //TODO:Extract to Service Implement
                    //union to get a non-repeat TagList
                    var totalTags = addTags.Union(memo.MemoTaggers.Select(x =&gt; x.Tag).ToList(), CNTag.TitleComparer);
                    //select the new tags to be added
                    var toBeAddedTag = totalTags.Where(x =&gt; string.IsNullOrEmpty(x.TagId));
                    //add them to memo
                    toBeAddedTag.ToList().ForEach(y =&gt;
                        memo.MemoTaggers.Add(new CNMemoTagger {Tag = y, MemoId = memo.MemoId}));
                }

                var removeTags = input.Get&lt;string&gt;(&quot;remove&quot;).Select(x =&gt; new CNTag {Title = x}).ToList();
                if (removeTags.Any())
                {
                    var toBeRemovedTag = memo.MemoTaggers.Select(x =&gt; x.Tag).ToList()
                        .Intersect(removeTags, CNTag.TitleComparer).ToList();
                    toBeRemovedTag.ForEach(x =&gt;
                        memo.MemoTaggers.Remove(memo.MemoTaggers.FirstOrDefault(y =&gt; y.TagId == x.TagId)));
                }

                State.Refresh();
            }
            else
            {
                Console.WriteLine(&quot;wrong parameter&quot;, Color.Red);
            }

            Console.WriteLine();
            return State;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[11,46,11,57,0],[12,9,12,10,0],[13,13,13,26,0],[14,9,14,10,0],[17,9,17,10,0],[18,13,18,33,0],[19,13,19,64,0],[20,13,20,14,0],[21,17,21,68,0],[21,68,21,89,0],[21,89,21,100,0],[21,17,21,100,0],[22,17,22,35,0],[23,17,23,18,0],[26,21,26,80,0],[26,80,26,85,0],[26,85,26,118,0],[26,21,26,118,0],[28,21,28,61,0],[28,61,28,90,0],[28,90,28,92,0],[28,21,28,92,0],[30,21,31,25,0],[31,25,31,95,0],[31,95,31,97,0],[30,21,31,97,0],[32,17,32,18,0],[34,17,34,74,0],[34,74,34,95,0],[34,95,34,106,0],[34,17,34,106,0],[35,17,35,38,0],[36,17,36,18,0],[37,21,37,71,0],[37,71,37,76,0],[37,76,38,78,0],[37,21,38,78,0],[39,21,40,25,0],[40,25,40,86,0],[40,86,40,104,0],[40,104,40,106,0],[40,25,40,106,0],[40,106,40,108,0],[39,21,40,108,0],[41,17,41,18,0],[43,17,43,33,0],[44,13,44,14,0],[45,18,45,69,0],[46,13,46,14,0],[47,17,47,68,0],[47,68,47,89,0],[47,89,47,100,0],[47,17,47,100,0],[48,17,48,35,0],[49,17,49,18,0],[52,21,52,80,0],[52,80,52,85,0],[52,85,52,118,0],[52,21,52,118,0],[54,21,54,61,0],[54,61,54,90,0],[54,90,54,92,0],[54,21,54,92,0],[56,21,57,25,0],[57,25,57,95,0],[57,95,57,97,0],[56,21,57,97,0],[58,17,58,18,0],[60,17,60,74,0],[60,74,60,95,0],[60,95,60,106,0],[60,17,60,106,0],[61,17,61,38,0],[62,17,62,18,0],[63,21,63,71,0],[63,71,63,76,0],[63,76,64,78,0],[63,21,64,78,0],[65,21,66,25,0],[66,25,66,86,0],[66,86,66,104,0],[66,104,66,106,0],[66,25,66,106,0],[66,106,66,108,0],[65,21,66,108,0],[67,17,67,18,0],[69,17,69,33,0],[70,13,70,14,0],[72,13,72,14,0],[73,17,73,65,0],[74,13,74,14,0],[76,13,76,33,0],[77,13,77,26,0],[78,9,78,10,0]]);
    </script>
  </body>
</html>