<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\cn_repository\datastore\taskdatastore.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using CN_Core;
using CN_Core.Interfaces.Repository;
using Microsoft.EntityFrameworkCore;

namespace CN_Repository
{
    public class TaskDataStore : BaseDataStore, ITaskDataStore
    {
        public TaskDataStore(CNDbContext dbContext) : base(dbContext)
        {
        }

        #region Delete Methods

        public async Task&lt;bool&gt; RemoveTask(CNTask targetTask)
        {
            return await IoC.Task.Run(
                async () =&gt;
                {
                    mDbContext.Tasks.Remove(targetTask);
                    return await mDbContext.SaveChangesAsync() &gt; 0;
                }, false);
        }

        public async Task&lt;bool&gt; RemoveTaskConnector(CNTaskConnector connector)
        {
            return await IoC.Task.Run(
                async () =&gt;
                {
                    mDbContext.TaskConnectors.Remove(connector);
                    return await mDbContext.SaveChangesAsync() &gt; 0;
                }, false);
        }

        #endregion

        #region Add Methods

        public async Task&lt;CNTask&gt; AddTask(CNTask targetTask)
        {
            return await IoC.Task.Run(
                async () =&gt;
                {
                    mDbContext.Tasks.Add(targetTask);
                    await mDbContext.SaveChangesAsync();
                    return targetTask;
                }, (CNTask) null);
        }

        #endregion

        #region Update Methods

        public async Task&lt;bool&gt; UpdateTask(CNTask targetTask)
        {
            return await IoC.Task.Run(
                async () =&gt;
                {
                    mDbContext.Tasks.Update(targetTask);
                    return await mDbContext.SaveChangesAsync() &gt; 0;
                }, false);
        }

        public async Task UpdateEndTaskTime(CNTask originDataTask, DateTime? targetEndTime)
        {
            await IoC.Task.Run(
                async () =&gt;
                {
                    if (originDataTask == null) return;
                    if (originDataTask.EndTime == null &amp;&amp; targetEndTime == null) return;
                    if (originDataTask.EndTime != null &amp;&amp; originDataTask.EndTime.Equals(targetEndTime)) return;
                    originDataTask.EndTime = targetEndTime;
                    mDbContext.Tasks.Update(originDataTask);
                    await mDbContext.SaveChangesAsync();
                });
        }

        public async Task UpdateStartTaskTime(CNTask originDataTask, DateTime? targetStartTime)
        {
            await IoC.Task.Run(
                async () =&gt;
                {
                    if (originDataTask == null) return;
                    if (originDataTask.StartTime == null &amp;&amp; targetStartTime == null) return;
                    if (originDataTask.StartTime != null &amp;&amp; originDataTask.StartTime.Equals(targetStartTime)) return;
                    originDataTask.StartTime = targetStartTime;
                    mDbContext.Tasks.Update(originDataTask);
                    await mDbContext.SaveChangesAsync();
                });
        }

        public async Task ExpandTaskTime(CNTask originDataTask, DateTime? targetStartTime, DateTime? targetEndTime)
        {
            await IoC.Task.Run(
                async () =&gt;
                {
                    //origintask null return
                    if (originDataTask == null) return;
                    //if this condition is fulfilled,than new time is smaller-or-equal compare to old ,do noting and return
                    if (originDataTask.StartTime != null &amp;&amp; originDataTask.EndTime != null &amp;&amp;
                        !(originDataTask.StartTime &gt; targetStartTime) &amp;&amp; !(originDataTask.EndTime &lt; targetEndTime) &amp;&amp;
                        targetEndTime != null) return;

                    //flag for update db
                    var needUpdate = false;
                    if (originDataTask.StartTime == null || originDataTask.StartTime &gt; targetStartTime)
                    {
                        originDataTask.StartTime = targetStartTime;
                        needUpdate = true;
                    }

                    if (originDataTask.EndTime == null &amp;&amp; targetEndTime != null || //Pause A Task
                        originDataTask.EndTime != null &amp;&amp; targetEndTime == null || //Start A Task
                        originDataTask.EndTime != null &amp;&amp; targetEndTime != null &amp;&amp;
                        originDataTask.EndTime &lt; targetEndTime
                    ) //Update A Task timeslice
                    {
                        originDataTask.EndTime = targetEndTime;
                        needUpdate = true;
                    }

                    if (!needUpdate) return;
                    mDbContext.Tasks.Update(originDataTask);
                    await mDbContext.SaveChangesAsync();
                });
        }

        #endregion

        #region Select Methods

        public async Task&lt;ICollection&lt;CNTask&gt;&gt; GetAllTask()
        {
            return await IoC.Task.Run(
                async () =&gt;
                    await mDbContext.Tasks.ToListAsync()
            );
        }

        public async Task&lt;CNTask&gt; GetTask(int taskid)
        {
            return await IoC.Task.Run(
                async () =&gt;
                    await mDbContext.Tasks
                        .FirstOrDefaultAsync(r =&gt; r.TaskId == taskid)
            );
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,55,12,70,1],[13,9,13,10,1],[14,9,14,10,1],[19,9,19,10,1],[20,13,22,17,1],[22,17,22,18,1],[22,18,23,21,1],[23,21,23,57,1],[23,57,24,21,1],[24,21,24,68,1],[24,68,25,17,1],[25,17,25,18,1],[25,18,25,27,1],[20,13,25,27,1],[26,9,26,10,1],[29,9,29,10,1],[30,13,32,17,1],[32,17,32,18,1],[32,18,33,21,1],[33,21,33,65,1],[33,65,34,21,1],[34,21,34,68,1],[34,68,35,17,1],[35,17,35,18,1],[35,18,35,27,1],[30,13,35,27,1],[36,9,36,10,1],[43,9,43,10,1],[44,13,46,17,1],[46,17,46,18,1],[46,18,47,21,1],[47,21,47,54,1],[47,54,48,21,1],[48,21,48,57,1],[48,57,49,21,1],[49,21,49,39,1],[49,39,50,17,1],[50,17,50,18,1],[50,18,50,35,1],[44,13,50,35,1],[51,9,51,10,1],[58,9,58,10,1],[59,13,61,17,1],[61,17,61,18,1],[61,18,62,21,1],[62,21,62,57,1],[62,57,63,21,1],[63,21,63,68,1],[63,68,64,17,1],[64,17,64,18,1],[64,18,64,27,1],[59,13,64,27,1],[65,9,65,10,1],[68,9,68,10,1],[69,13,71,17,1],[71,17,71,18,1],[71,18,72,21,1],[72,21,72,48,1],[72,48,72,49,1],[72,49,72,56,1],[72,56,73,21,1],[73,21,73,81,1],[73,81,73,82,1],[73,82,73,89,1],[73,89,74,21,1],[74,21,74,104,1],[74,104,74,105,1],[74,105,74,112,1],[74,112,75,21,1],[75,21,75,60,1],[75,60,76,21,1],[76,21,76,61,1],[76,61,77,21,1],[77,21,77,57,1],[77,57,78,17,1],[78,17,78,18,1],[78,18,78,20,1],[69,13,78,20,1],[79,9,79,10,1],[82,9,82,10,1],[83,13,85,17,1],[85,17,85,18,1],[85,18,86,21,1],[86,21,86,48,1],[86,48,86,49,1],[86,49,86,56,1],[86,56,87,21,1],[87,21,87,85,1],[87,85,87,86,1],[87,86,87,93,1],[87,93,88,21,1],[88,21,88,110,1],[88,110,88,111,1],[88,111,88,118,1],[88,118,89,21,1],[89,21,89,64,1],[89,64,90,21,1],[90,21,90,61,1],[90,61,91,21,1],[91,21,91,57,1],[91,57,92,17,1],[92,17,92,18,1],[92,18,92,20,1],[83,13,92,20,1],[93,9,93,10,1],[96,9,96,10,1],[97,13,99,17,1],[99,17,99,18,1],[99,18,101,21,1],[101,21,101,48,1],[101,48,101,49,1],[101,49,101,56,1],[101,56,103,21,1],[103,21,105,47,1],[105,47,105,48,1],[105,48,105,55,1],[105,55,108,21,1],[108,21,108,44,1],[108,44,109,21,1],[109,21,109,104,1],[109,104,110,21,1],[110,21,110,22,1],[110,22,111,25,1],[111,25,111,68,1],[111,68,112,25,1],[112,25,112,43,1],[112,43,113,21,1],[113,21,113,22,1],[113,22,115,21,1],[115,21,119,22,1],[119,22,120,21,1],[120,21,120,22,1],[120,22,121,25,1],[121,25,121,64,1],[121,64,122,25,1],[122,25,122,43,1],[122,43,123,21,1],[123,21,123,22,1],[123,22,125,21,1],[125,21,125,37,1],[125,37,125,38,1],[125,38,125,45,1],[125,45,126,21,1],[126,21,126,61,1],[126,61,127,21,1],[127,21,127,57,1],[127,57,128,17,1],[128,17,128,18,1],[128,18,128,20,1],[97,13,128,20,1],[129,9,129,10,1],[136,9,136,10,1],[137,13,139,21,1],[139,21,139,57,1],[139,57,140,15,1],[137,13,140,15,1],[141,9,141,10,1],[144,9,144,10,1],[145,13,147,21,1],[147,21,148,70,1],[148,70,149,15,1],[145,13,149,15,1],[150,9,150,10,1]]);
    </script>
  </body>
</html>