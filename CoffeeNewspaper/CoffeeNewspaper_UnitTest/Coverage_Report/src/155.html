<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\coffeenewspaper_unittest\integrationtest\repositorytest\timeslicedatastoretest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Threading.Tasks;
using CN_Repository;
using CoffeeNewspaper_UnitTest.DomainTest;
using NUnit.Framework;

namespace CoffeeNewspaper_UnitTest.RepositoryTest
{
    /// &lt;summary&gt;
    ///     In-TimeSlicery integration data persistent test
    /// &lt;/summary&gt;
    [TestFixture]
    public class TimeSliceDataStoreTest : RepositarySetupAndTearDown
    {
        [Test]
        public async Task AddTimeSlice_QueryAllTimeSlice_QuerySpecifiedTimeSlice_AllPass()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                //Arrange argument to be tested
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                var task = DomainTestHelper.GetARandomTask();

                //add this timeslice to task
                assesTimeSlice.Task = task;

                //initiate the datastore
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);

                //do testing action
                var addedTimeSlice = await TimeSliceDataStore.AddTimeSlice(assesTimeSlice);

                //query the result from db for assert
                var TimeSlices = await TimeSliceDataStore.GetTimeSliceByTaskID(addedTimeSlice.TaskId);

                var firstTimeSlice = await TimeSliceDataStore.GetTimeSliceById(TimeSlices.First().TimeSliceId);

                Assert.AreEqual(TimeSlices.First(), firstTimeSlice);
                Assert.AreEqual(TimeSlices.FirstOrDefault(), assesTimeSlice);
            });
        }

        [Test]
        public async Task AddTimeSlice_WithoutTask_Fail()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                //Arrange argument to be tested
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();

                //initiate the datastore
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);

                //do testing action
                var addedTimeSlice = await TimeSliceDataStore.AddTimeSlice(assesTimeSlice);

                Assert.IsNull(addedTimeSlice);
            });
        }

        [Test]
        public async Task DeleteATimeSlice_Success()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                //Arrange argument to be tested
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                var task = DomainTestHelper.GetARandomTask();

                //add this timeslice to task
                assesTimeSlice.Task = task;

                var addedTimeSlice = await TimeSliceDataStore.AddTimeSlice(assesTimeSlice);


                var beforeDeleteResult = await TimeSliceDataStore.DeleteTimeSlice(addedTimeSlice);
                Assert.IsTrue(beforeDeleteResult);

                var afterDeleteResult = await TimeSliceDataStore.GetTimeSliceById(addedTimeSlice.TimeSliceId);
                Assert.IsNull(afterDeleteResult);
            });
        }

        [Test]
        public async Task DeleteATimeSlice_TimeSliceIdNotExist_Fail()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                assesTimeSlice.TimeSliceId = Guid.NewGuid().ToString(&quot;D&quot;);
                var beforeDeleteResult = await TimeSliceDataStore.DeleteTimeSlice(assesTimeSlice);
                Assert.IsFalse(beforeDeleteResult);
            });
        }

        [Test]
        public async Task QuerySpecifiedTimeSliceDoesntExist_ReturnNull()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                var firstTimeSlice = await TimeSliceDataStore.GetTimeSliceById(Guid.NewGuid().ToString(&quot;D&quot;));

                Assert.IsNull(firstTimeSlice);
            });
        }

        [Test]
        public async Task UpdateTimeSlice()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                //Arrange argument to be tested
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                var task = DomainTestHelper.GetARandomTask();

                //add this timeslice to task
                assesTimeSlice.Task = task;
                var addedTimeSlice = await TimeSliceDataStore.AddTimeSlice(assesTimeSlice);

                //update the added TimeSlice content,make sure its not equal to original TimeSlice
                addedTimeSlice.EndDateTime = DateTime.Now.AddDays(1);

                //update to database ,make sure what ef return is equal to modified TimeSlice
                var updatedResult = await TimeSliceDataStore.UpdateTimeSlice(addedTimeSlice);

                Assert.IsTrue(updatedResult);
                //select from db again ,make sure the TimeSlice is updated
                var selectedTimeSlice = await TimeSliceDataStore.GetTimeSliceById(addedTimeSlice.TimeSliceId);
                Assert.AreEqual(selectedTimeSlice, addedTimeSlice);
            });
        }

        [Test]
        public async Task UpdateTimeSlice_TimeSliceIdNotExist_Fail()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                assesTimeSlice.TimeSliceId = Guid.NewGuid().ToString(&quot;D&quot;);

                //update the added TimeSlice content,make sure its not equal to original TimeSlice
                assesTimeSlice.EndDateTime = DateTime.Now.AddDays(1);

                //update to database ,make sure what ef return is equal to modified TimeSlice
                var updatedResult = await TimeSliceDataStore.UpdateTimeSlice(assesTimeSlice);

                Assert.False(updatedResult);
            });
        }

        [Test]
        public async Task UpdateTimeSlice_TryDeleteTheTaskId_Fail()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                //Arrange argument to be tested
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                var task = DomainTestHelper.GetARandomTask();

                //add this timeslice to task
                assesTimeSlice.Task = task;
                var addedTimeSlice = await TimeSliceDataStore.AddTimeSlice(assesTimeSlice);

                //try delete the task relation
                addedTimeSlice.Task = null;
                addedTimeSlice.TaskId = 0;

                //update to database ,make sure what ef return is equal to modified TimeSlice
                var updatedResult = await TimeSliceDataStore.UpdateTimeSlice(addedTimeSlice);

                Assert.IsFalse(updatedResult);
            });
        }

        [Test] 
        public async Task DeleteTimeSliceByTask_Success()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var TimeSliceDataStore = new TimeSliceDataStore(dbcontext);
                //Arrange argument to be tested
                var assesTimeSlice = DomainTestHelper.GetARandomTimeSlice();
                var task = DomainTestHelper.GetARandomTask();
                //add this timeslice to task
                task.UsedTimeSlices.Add(assesTimeSlice);
                var TaskDataStore = new TaskDataStore(dbcontext);
                await TaskDataStore.AddTask(task);

                //action
                var result = await TimeSliceDataStore.DeleteTimeSliceByTask(task.TaskId);
                
                Assert.IsTrue(result);

                var finalTask = await TaskDataStore.GetTask(task.TaskId);
                Assert.IsTrue(finalTask.UsedTimeSlices== null|| finalTask.UsedTimeSlices.Count == 0);
            });
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,1],[19,13,20,13,1],[20,13,20,14,1],[20,14,22,17,1],[22,17,22,77,1],[22,77,23,17,1],[23,17,23,62,1],[23,62,26,17,1],[26,17,26,44,1],[26,44,29,17,1],[29,17,29,76,1],[29,76,32,17,1],[32,17,32,92,1],[32,92,35,17,1],[35,17,35,103,1],[35,103,37,17,1],[37,17,37,112,1],[37,112,39,17,1],[39,17,39,69,1],[39,69,40,17,1],[40,17,40,78,1],[40,78,41,13,1],[41,13,41,14,1],[41,14,41,16,1],[19,13,41,16,1],[42,9,42,10,1],[46,9,46,10,1],[47,13,48,13,1],[48,13,48,14,1],[48,14,50,17,1],[50,17,50,77,1],[50,77,53,17,1],[53,17,53,76,1],[53,76,56,17,1],[56,17,56,92,1],[56,92,58,17,1],[58,17,58,47,1],[58,47,59,13,1],[59,13,59,14,1],[59,14,59,16,1],[47,13,59,16,1],[60,9,60,10,1],[64,9,64,10,1],[65,13,66,13,1],[66,13,66,14,1],[66,14,67,17,1],[67,17,67,76,1],[67,76,69,17,1],[69,17,69,77,1],[69,77,70,17,1],[70,17,70,62,1],[70,62,73,17,1],[73,17,73,44,1],[73,44,75,17,1],[75,17,75,92,1],[75,92,78,17,1],[78,17,78,99,1],[78,99,79,17,1],[79,17,79,51,1],[79,51,81,17,1],[81,17,81,111,1],[81,111,82,17,1],[82,17,82,50,1],[82,50,83,13,1],[83,13,83,14,1],[83,14,83,16,1],[65,13,83,16,1],[84,9,84,10,1],[88,9,88,10,1],[89,13,90,13,1],[90,13,90,14,1],[90,14,91,17,1],[91,17,91,76,1],[91,76,92,17,1],[92,17,92,77,1],[92,77,93,17,1],[93,17,93,75,1],[93,75,94,17,1],[94,17,94,99,1],[94,99,95,17,1],[95,17,95,52,1],[95,52,96,13,1],[96,13,96,14,1],[96,14,96,16,1],[89,13,96,16,1],[97,9,97,10,1],[101,9,101,10,1],[102,13,103,13,1],[103,13,103,14,1],[103,14,104,17,1],[104,17,104,76,1],[104,76,105,17,1],[105,17,105,110,1],[105,110,107,17,1],[107,17,107,47,1],[107,47,108,13,1],[108,13,108,14,1],[108,14,108,16,1],[102,13,108,16,1],[109,9,109,10,1],[113,9,113,10,1],[114,13,115,13,1],[115,13,115,14,1],[115,14,116,17,1],[116,17,116,76,1],[116,76,118,17,1],[118,17,118,77,1],[118,77,119,17,1],[119,17,119,62,1],[119,62,122,17,1],[122,17,122,44,1],[122,44,123,17,1],[123,17,123,92,1],[123,92,126,17,1],[126,17,126,70,1],[126,70,129,17,1],[129,17,129,94,1],[129,94,131,17,1],[131,17,131,46,1],[131,46,133,17,1],[133,17,133,111,1],[133,111,134,17,1],[134,17,134,68,1],[134,68,135,13,1],[135,13,135,14,1],[135,14,135,16,1],[114,13,135,16,1],[136,9,136,10,1],[140,9,140,10,1],[141,13,142,13,1],[142,13,142,14,1],[142,14,143,17,1],[143,17,143,76,1],[143,76,144,17,1],[144,17,144,77,1],[144,77,145,17,1],[145,17,145,75,1],[145,75,148,17,1],[148,17,148,70,1],[148,70,151,17,1],[151,17,151,94,1],[151,94,153,17,1],[153,17,153,45,1],[153,45,154,13,1],[154,13,154,14,1],[154,14,154,16,1],[141,13,154,16,1],[155,9,155,10,1],[159,9,159,10,1],[160,13,161,13,1],[161,13,161,14,1],[161,14,162,17,1],[162,17,162,76,1],[162,76,164,17,1],[164,17,164,77,1],[164,77,165,17,1],[165,17,165,62,1],[165,62,168,17,1],[168,17,168,44,1],[168,44,169,17,1],[169,17,169,92,1],[169,92,172,17,1],[172,17,172,44,1],[172,44,173,17,1],[173,17,173,43,1],[173,43,176,17,1],[176,17,176,94,1],[176,94,178,17,1],[178,17,178,47,1],[178,47,179,13,1],[179,13,179,14,1],[179,14,179,16,1],[160,13,179,16,1],[180,9,180,10,1],[184,9,184,10,1],[185,13,186,13,1],[186,13,186,14,1],[186,14,187,17,1],[187,17,187,76,1],[187,76,189,17,1],[189,17,189,77,1],[189,77,190,17,1],[190,17,190,62,1],[190,62,192,17,1],[192,17,192,57,1],[192,57,193,17,1],[193,17,193,66,1],[193,66,194,17,1],[194,17,194,51,1],[194,51,197,17,1],[197,17,197,90,1],[197,90,199,17,1],[199,17,199,39,1],[199,39,201,17,1],[201,17,201,74,1],[201,74,202,17,1],[202,17,202,102,1],[202,102,203,13,1],[203,13,203,14,1],[203,14,203,16,1],[185,13,203,16,1],[204,9,204,10,1]]);
    </script>
  </body>
</html>