<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>e:\githubproject\coffeenewspaper\coffeenewspaper\coffeenewspaper_unittest\integrationtest\repositorytest\memodatastoretest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.NetworkInformation;
using System.Threading.Tasks;
using CN_Core;
using CN_Repository;
using CoffeeNewspaper_UnitTest.DomainTest;
using NUnit.Framework;

namespace CoffeeNewspaper_UnitTest.RepositoryTest
{
    /// &lt;summary&gt;
    ///     In-Memory integration data persistent test
    /// &lt;/summary&gt;
    [TestFixture]
    public class MemoDataStoreTest : RepositarySetupAndTearDown
    {
        [Test]
        public async Task AddMemo_QueryAllMemo_QuerySpecifiedMemo_AllPass()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                //Arrange argument to be tested
                var assesMemo = DomainTestHelper.GetARandomMemo();

                //initiate the datastore
                var MemoDataStore = new MemoDataStore(dbcontext);

                //do testing action
                await MemoDataStore.AddMemo(assesMemo);

                //query the result from db for assert
                var Memos = await MemoDataStore.GetAllGlobalMemos();
                Memos.ToList().ForEach(Console.WriteLine);

                var firstMemo = await MemoDataStore.GetMemoById(Memos.First().MemoId);

                Assert.AreEqual(Memos.First(), firstMemo);
                Assert.AreEqual(Memos.FirstOrDefault(), assesMemo);
            });
        }

        [Test]
        public async Task DeleteAMemo_Success()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = await MemoDataStore.AddMemo(assesMemo);


                var beforeDeleteResult = await MemoDataStore.DeleteMemo(addedMemo);
                Assert.IsTrue(beforeDeleteResult);

                var afterDeleteResult = await MemoDataStore.GetMemoById(addedMemo.MemoId);
                Assert.IsNull(afterDeleteResult);
            });
        }

        [Test]
        public async Task DeleteAMemo_MemoIdNotExist_Fail()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo(true);
                var beforeDeleteResult = await MemoDataStore.DeleteMemo(assesMemo);
                Assert.IsFalse(beforeDeleteResult);
            });
        }

        [Test]
        public async Task QuerySpecifiedMemoDoesntExist_ReturnNull()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var firstMemo = await MemoDataStore.GetMemoById(Guid.NewGuid().ToString(&quot;D&quot;));

                Assert.IsNull(firstMemo);
            });
        }

        [Test]
        public async Task UpdateMemo()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = await MemoDataStore.AddMemo(assesMemo);

                //update the added Memo content,make sure its not equal to original Memo
                addedMemo.Content = &quot;testing update&quot;;

                //update to database ,make sure what ef return is equal to modified Memo
                var updatedResult = await MemoDataStore.UpdateMemo(addedMemo);

                Assert.IsTrue(updatedResult);
                //select from db again ,make sure the Memo is updated
                var selectedMemo = await MemoDataStore.GetMemoById(addedMemo.MemoId);
                Assert.AreEqual(selectedMemo, addedMemo);
            });
        }

        [Test]
        public async Task UpdateMemo_MemoIdNotExist_Fail()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo(true);

                //update the added Memo content,make sure its not equal to original Memo
                assesMemo.Content = &quot;testing update&quot;;

                //update to database ,make sure what ef return is equal to modified Memo
                var updatedResult = await MemoDataStore.UpdateMemo(assesMemo);

                Assert.False(updatedResult);
            });
        }

        [Test]
        public async Task Clone_SimpleGlobalMemo()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = await MemoDataStore.AddMemo(assesMemo);
                var cloneMemo = await MemoDataStore.CloneAMemo(addedMemo.MemoId);

                var allMemos = await MemoDataStore.GetAllGlobalMemos();
                Assert.AreEqual(2,allMemos.Count);

                Assert.IsNotNull(cloneMemo);
                Assert.AreNotEqual(addedMemo.MemoId,cloneMemo.MemoId);
            });
        }

        [Test]
        public async Task Clone_OriginalMemoNull_ReturnFalse()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var addedMemo = await MemoDataStore.AddMemo(assesMemo);
                var cloneMemo = await MemoDataStore.CloneAMemo(Guid.NewGuid().ToString(&quot;N&quot;));

                var allMemos = await MemoDataStore.GetAllGlobalMemos();
                Assert.AreEqual(1, allMemos.Count);

                Assert.IsNull(cloneMemo);
            });
        }

        [Test]
        public async Task GetAllTaskMemos_Success()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);

                var taskDataStore = new TaskDataStore(dbcontext);
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var assesTask = DomainTestHelper.GetARandomTask();
                assesTask.TaskMemos = new List&lt;CNTaskMemo&gt;(){new CNTaskMemo(){Memo = assesMemo,Task = assesTask}};
                var addedTask = await taskDataStore.AddTask(assesTask);

                var allMemos = await MemoDataStore.GetAllTaskMemos(addedTask.TaskId);
                Assert.AreEqual(1, allMemos.Count);
                Assert.AreEqual(assesMemo.Content, allMemos.First().Content);
            });
        }

        /// &lt;summary&gt;
        /// Some Memo Contain Relations
        /// this test will assert those relations are cloned properly
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Test]
        public async Task Clone_ComplicatedMemo()
        {
            await UseMemoryContextRun(async dbcontext =&gt;
            {
                var MemoDataStore = new MemoDataStore(dbcontext);

                //arrange initial entity
                var assesMemo = DomainTestHelper.GetARandomMemo();
                var task = DomainTestHelper.GetARandomTask();
                var tags = new[] {DomainTestHelper.GetARandomTag(), DomainTestHelper.GetARandomTag()}.ToList();

                //add relations
                assesMemo.TaskMemos = new List&lt;CNTaskMemo&gt;(){new CNTaskMemo(){Memo = assesMemo,Task = task}};
                task.TaskTaggers = tags.Select(x=&gt;new CNTaskTagger(){Tag =x,Task = task}).ToList();
                assesMemo.MemoTaggers = tags.Select(x =&gt; new CNMemoTagger() { Tag = x, Memo = assesMemo }).ToList();

                var addedMemo = await MemoDataStore.AddMemo(assesMemo);
                var cloneMemo = await MemoDataStore.CloneAMemo(addedMemo.MemoId);

                Assert.AreEqual(addedMemo.TaskMemos.First().TaskId, cloneMemo.TaskMemos.First().TaskId);
                Assert.AreEqual(addedMemo.MemoTaggers.First().TagId, cloneMemo.MemoTaggers.First().TagId);

            });
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,23,13,1],[23,13,23,14,1],[23,14,25,17,1],[25,17,25,67,1],[25,67,28,17,1],[28,17,28,66,1],[28,66,31,17,1],[31,17,31,56,1],[31,56,34,17,1],[34,17,34,69,1],[34,69,35,17,1],[35,17,35,59,1],[35,59,37,17,1],[37,17,37,87,1],[37,87,39,17,1],[39,17,39,59,1],[39,59,40,17,1],[40,17,40,68,1],[40,68,41,13,1],[41,13,41,14,1],[41,14,41,16,1],[22,13,41,16,1],[42,9,42,10,1],[46,9,46,10,1],[47,13,48,13,1],[48,13,48,14,1],[48,14,49,17,1],[49,17,49,66,1],[49,66,50,17,1],[50,17,50,67,1],[50,67,51,17,1],[51,17,51,72,1],[51,72,54,17,1],[54,17,54,84,1],[54,84,55,17,1],[55,17,55,51,1],[55,51,57,17,1],[57,17,57,91,1],[57,91,58,17,1],[58,17,58,50,1],[58,50,59,13,1],[59,13,59,14,1],[59,14,59,16,1],[47,13,59,16,1],[60,9,60,10,1],[64,9,64,10,1],[65,13,66,13,1],[66,13,66,14,1],[66,14,67,17,1],[67,17,67,66,1],[67,66,68,17,1],[68,17,68,71,1],[68,71,69,17,1],[69,17,69,84,1],[69,84,70,17,1],[70,17,70,52,1],[70,52,71,13,1],[71,13,71,14,1],[71,14,71,16,1],[65,13,71,16,1],[72,9,72,10,1],[76,9,76,10,1],[77,13,78,13,1],[78,13,78,14,1],[78,14,79,17,1],[79,17,79,66,1],[79,66,80,17,1],[80,17,80,95,1],[80,95,82,17,1],[82,17,82,42,1],[82,42,83,13,1],[83,13,83,14,1],[83,14,83,16,1],[77,13,83,16,1],[84,9,84,10,1],[88,9,88,10,1],[89,13,90,13,1],[90,13,90,14,1],[90,14,91,17,1],[91,17,91,66,1],[91,66,92,17,1],[92,17,92,67,1],[92,67,93,17,1],[93,17,93,72,1],[93,72,96,17,1],[96,17,96,54,1],[96,54,99,17,1],[99,17,99,79,1],[99,79,101,17,1],[101,17,101,46,1],[101,46,103,17,1],[103,17,103,86,1],[103,86,104,17,1],[104,17,104,58,1],[104,58,105,13,1],[105,13,105,14,1],[105,14,105,16,1],[89,13,105,16,1],[106,9,106,10,1],[110,9,110,10,1],[111,13,112,13,1],[112,13,112,14,1],[112,14,113,17,1],[113,17,113,66,1],[113,66,114,17,1],[114,17,114,71,1],[114,71,117,17,1],[117,17,117,54,1],[117,54,120,17,1],[120,17,120,79,1],[120,79,122,17,1],[122,17,122,45,1],[122,45,123,13,1],[123,13,123,14,1],[123,14,123,16,1],[111,13,123,16,1],[124,9,124,10,1],[128,9,128,10,1],[129,13,130,13,1],[130,13,130,14,1],[130,14,131,17,1],[131,17,131,66,1],[131,66,132,17,1],[132,17,132,67,1],[132,67,133,17,1],[133,17,133,72,1],[133,72,134,17,1],[134,17,134,82,1],[134,82,136,17,1],[136,17,136,72,1],[136,72,137,17,1],[137,17,137,51,1],[137,51,139,17,1],[139,17,139,45,1],[139,45,140,17,1],[140,17,140,71,1],[140,71,141,13,1],[141,13,141,14,1],[141,14,141,16,1],[129,13,141,16,1],[142,9,142,10,1],[146,9,146,10,1],[147,13,148,13,1],[148,13,148,14,1],[148,14,149,17,1],[149,17,149,66,1],[149,66,150,17,1],[150,17,150,67,1],[150,67,151,17,1],[151,17,151,72,1],[151,72,152,17,1],[152,17,152,94,1],[152,94,154,17,1],[154,17,154,72,1],[154,72,155,17,1],[155,17,155,52,1],[155,52,157,17,1],[157,17,157,42,1],[157,42,158,13,1],[158,13,158,14,1],[158,14,158,16,1],[147,13,158,16,1],[159,9,159,10,1],[163,9,163,10,1],[164,13,165,13,1],[165,13,165,14,1],[165,14,166,17,1],[166,17,166,66,1],[166,66,168,17,1],[168,17,168,66,1],[168,66,169,17,1],[169,17,169,67,1],[169,67,170,17,1],[170,17,170,67,1],[170,67,171,17,1],[171,17,171,115,1],[171,115,172,17,1],[172,17,172,72,1],[172,72,174,17,1],[174,17,174,86,1],[174,86,175,17,1],[175,17,175,52,1],[175,52,176,17,1],[176,17,176,78,1],[176,78,177,13,1],[177,13,177,14,1],[177,14,177,16,1],[164,13,177,16,1],[178,9,178,10,1],[187,9,187,10,1],[188,13,189,13,1],[189,13,189,14,1],[189,14,190,17,1],[190,17,190,66,1],[190,66,193,17,1],[193,17,193,67,1],[193,67,194,17,1],[194,17,194,62,1],[194,62,195,17,1],[195,17,195,112,1],[195,112,198,17,1],[198,17,198,110,1],[198,110,199,17,1],[199,17,199,51,1],[199,51,199,89,1],[199,89,199,100,1],[199,17,199,100,1],[199,100,200,17,1],[200,17,200,58,1],[200,58,200,106,1],[200,106,200,117,1],[200,17,200,117,1],[200,117,202,17,1],[202,17,202,72,1],[202,72,203,17,1],[203,17,203,82,1],[203,82,205,17,1],[205,17,205,105,1],[205,105,206,17,1],[206,17,206,107,1],[206,107,208,13,1],[208,13,208,14,1],[208,14,208,16,1],[188,13,208,16,1],[209,9,209,10,1]]);
    </script>
  </body>
</html>